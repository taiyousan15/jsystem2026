generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// ============================================================
// 1. ユーザーテーブル（Clerkと同期）
// ============================================================
model User {
  id          String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  clerkId     String   @unique @map("clerk_id") @db.VarChar(255)
  email       String   @unique @db.VarChar(255)
  displayName String   @map("display_name") @db.VarChar(100)
  avatarUrl   String?  @map("avatar_url")
  bio         String?
  role        String   @default("member") @db.VarChar(20)
  createdAt   DateTime @default(now()) @map("created_at") @db.Timestamptz()
  updatedAt   DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamptz()

  pointBalance     PointBalance?
  pointTransactions PointTransaction[]
  userBadges       UserBadge[]
  userStreak       UserStreak?
  dailyMissions    DailyMission[]
  eventAttendees   EventAttendee[]
  exchangeRequests ExchangeRequest[]
  shippingAddresses ShippingAddress[]
  notifications    Notification[]
  notificationSettings NotificationSettings?
  referralsSent    Referral[]  @relation("Referrer")
  referralsReceived Referral[] @relation("Referred")
  auditLogs        AuditLog[]
  createdEvents    Event[]     @relation("EventCreator")
  zoomMappings       ZoomUserMapping[]
  zoomParticipations ZoomParticipationLog[]

  @@index([clerkId])
  @@index([email])
  @@index([role])
  @@map("users")
}

// ============================================================
// 2. マイル残高テーブル
// ============================================================
model PointBalance {
  userId       String   @id @map("user_id") @db.Uuid
  totalMiles   Int      @default(0) @map("total_miles")
  lifetimeMiles Int     @default(0) @map("lifetime_miles")
  tier         String   @default("bronze") @db.VarChar(20)
  updatedAt    DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamptz()

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("point_balances")
}

// ============================================================
// 3. マイルトランザクションテーブル（追記専用・イミュータブル）
// ============================================================
model PointTransaction {
  id        String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId    String    @map("user_id") @db.Uuid
  amount    Int
  type      String    @db.VarChar(20)
  source    String    @db.VarChar(100)
  metadata  Json      @default("{}")
  expiresAt DateTime? @map("expires_at") @db.Timestamptz()
  createdAt DateTime  @default(now()) @map("created_at") @db.Timestamptz()

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([userId, createdAt(sort: Desc)])
  @@index([type])
  @@index([source])
  @@map("point_transactions")
}

// ============================================================
// 4. マイル獲得ルールテーブル
// ============================================================
model MileRule {
  id              String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  actionCode      String   @unique @map("action_code") @db.VarChar(50)
  actionName      String   @map("action_name") @db.VarChar(100)
  baseMiles       Int      @map("base_miles")
  dailyLimit      Int?     @map("daily_limit")
  cooldownSeconds Int      @default(5) @map("cooldown_seconds")
  isActive        Boolean  @default(true) @map("is_active")
  conditions      Json     @default("{}")
  createdAt       DateTime @default(now()) @map("created_at") @db.Timestamptz()
  updatedAt       DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamptz()

  @@map("mile_rules")
}

// ============================================================
// 5. バッジマスターテーブル
// ============================================================
model Badge {
  id          String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name        String   @db.VarChar(100)
  description String
  iconUrl     String   @map("icon_url")
  category    String   @db.VarChar(50)
  rarity      String   @default("common") @db.VarChar(20)
  condition   Json
  isActive    Boolean  @default(true) @map("is_active")
  createdAt   DateTime @default(now()) @map("created_at") @db.Timestamptz()

  userBadges UserBadge[]

  @@map("badges")
}

// ============================================================
// 6. ユーザーバッジテーブル
// ============================================================
model UserBadge {
  userId   String   @map("user_id") @db.Uuid
  badgeId  String   @map("badge_id") @db.Uuid
  earnedAt DateTime @default(now()) @map("earned_at") @db.Timestamptz()

  user  User  @relation(fields: [userId], references: [id], onDelete: Cascade)
  badge Badge @relation(fields: [badgeId], references: [id], onDelete: Cascade)

  @@id([userId, badgeId])
  @@index([userId])
  @@map("user_badges")
}

// ============================================================
// 7. ストリークテーブル
// ============================================================
model UserStreak {
  userId          String   @id @map("user_id") @db.Uuid
  currentStreak   Int      @default(0) @map("current_streak")
  longestStreak   Int      @default(0) @map("longest_streak")
  lastActiveDate  DateTime? @map("last_active_date") @db.Date
  freezeRemaining Int      @default(2) @map("freeze_remaining")
  updatedAt       DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamptz()

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("user_streaks")
}

// ============================================================
// 8. デイリーミッションテーブル
// ============================================================
model DailyMission {
  id           String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId       String   @map("user_id") @db.Uuid
  title        String   @db.VarChar(200)
  description  String?
  actionCode   String   @map("action_code") @db.VarChar(50)
  targetCount  Int      @default(1) @map("target_count")
  currentCount Int      @default(0) @map("current_count")
  rewardMiles  Int      @default(20) @map("reward_miles")
  status       String   @default("active") @db.VarChar(20)
  date         DateTime @db.Date
  createdAt    DateTime @default(now()) @map("created_at") @db.Timestamptz()

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, date])
  @@unique([userId, date, actionCode])
  @@map("daily_missions")
}

// ============================================================
// 9. イベントテーブル
// ============================================================
model Event {
  id           String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  title        String    @db.VarChar(200)
  description  String?
  type         String    @db.VarChar(30)
  startAt      DateTime  @map("start_at") @db.Timestamptz()
  endAt        DateTime  @map("end_at") @db.Timestamptz()
  location     String?
  onlineUrl    String?   @map("online_url")
  capacity     Int
  milesReward  Int       @default(0) @map("miles_reward")
  qrPayload    String    @unique @map("qr_payload") @db.VarChar(255)
  isPaid       Boolean   @default(false) @map("is_paid")
  price        Int?
  tierRequired String?   @map("tier_required") @db.VarChar(20)
  status       String    @default("upcoming") @db.VarChar(20)
  createdBy    String?   @map("created_by") @db.Uuid
  createdAt    DateTime  @default(now()) @map("created_at") @db.Timestamptz()
  updatedAt    DateTime  @default(now()) @updatedAt @map("updated_at") @db.Timestamptz()

  creator            User?               @relation("EventCreator", fields: [createdBy], references: [id])
  attendees          EventAttendee[]
  zoomMeetingRecords ZoomMeetingRecord[]

  @@index([status])
  @@index([startAt])
  @@map("events")
}

// ============================================================
// 10. イベント参加者テーブル
// ============================================================
model EventAttendee {
  eventId      String    @map("event_id") @db.Uuid
  userId       String    @map("user_id") @db.Uuid
  checkedIn    Boolean   @default(false) @map("checked_in")
  checkedInAt  DateTime? @map("checked_in_at") @db.Timestamptz()
  registeredAt DateTime  @default(now()) @map("registered_at") @db.Timestamptz()

  event Event @relation(fields: [eventId], references: [id], onDelete: Cascade)
  user  User  @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@id([eventId, userId])
  @@index([userId])
  @@map("event_attendees")
}

// ============================================================
// 11. 交換カタログテーブル
// ============================================================
model CatalogItem {
  id            String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name          String   @db.VarChar(200)
  description   String
  imageUrl      String?  @map("image_url")
  category      String   @db.VarChar(30)
  requiredMiles Int      @map("required_miles")
  stock         Int?
  isActive      Boolean  @default(true) @map("is_active")
  metadata      Json     @default("{}")
  createdAt     DateTime @default(now()) @map("created_at") @db.Timestamptz()
  updatedAt     DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamptz()

  exchangeRequests ExchangeRequest[]

  @@index([category])
  @@map("catalog_items")
}

// ============================================================
// 12. 交換申請テーブル
// ============================================================
model ExchangeRequest {
  id                String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId            String   @map("user_id") @db.Uuid
  catalogItemId     String   @map("catalog_item_id") @db.Uuid
  milesSpent        Int      @map("miles_spent")
  status            String   @default("pending") @db.VarChar(20)
  shippingAddressId String?  @map("shipping_address_id") @db.Uuid
  trackingNumber    String?  @map("tracking_number") @db.VarChar(100)
  adminNote         String?  @map("admin_note")
  createdAt         DateTime @default(now()) @map("created_at") @db.Timestamptz()
  updatedAt         DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamptz()

  user            User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  catalogItem     CatalogItem      @relation(fields: [catalogItemId], references: [id])
  shippingAddress ShippingAddress?  @relation(fields: [shippingAddressId], references: [id])

  @@index([userId])
  @@index([status])
  @@map("exchange_requests")
}

// ============================================================
// 13. 配送先住所テーブル
// ============================================================
model ShippingAddress {
  id             String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId         String   @map("user_id") @db.Uuid
  recipientName  String   @map("recipient_name") @db.VarChar(100)
  postalCode     String   @map("postal_code") @db.VarChar(10)
  prefecture     String   @db.VarChar(10)
  city           String   @db.VarChar(100)
  addressLine    String   @map("address_line")
  phone          String   @db.VarChar(20)
  isDefault      Boolean  @default(false) @map("is_default")
  createdAt      DateTime @default(now()) @map("created_at") @db.Timestamptz()

  user             User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  exchangeRequests ExchangeRequest[]

  @@index([userId])
  @@map("shipping_addresses")
}

// ============================================================
// 14. 通知テーブル
// ============================================================
model Notification {
  id        String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId    String   @map("user_id") @db.Uuid
  type      String   @db.VarChar(30)
  title     String   @db.VarChar(200)
  body      String
  isRead    Boolean  @default(false) @map("is_read")
  metadata  Json     @default("{}")
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz()

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, createdAt(sort: Desc)])
  @@map("notifications")
}

// ============================================================
// 15. 通知設定テーブル
// ============================================================
model NotificationSettings {
  userId          String   @id @map("user_id") @db.Uuid
  mileEarned      Boolean  @default(true) @map("mile_earned")
  badgeEarned     Boolean  @default(true) @map("badge_earned")
  tierChange      Boolean  @default(true) @map("tier_change")
  streakReminder  Boolean  @default(true) @map("streak_reminder")
  eventReminder   Boolean  @default(true) @map("event_reminder")
  exchangeUpdate  Boolean  @default(true) @map("exchange_update")
  emailEnabled    Boolean  @default(true) @map("email_enabled")
  pushEnabled     Boolean  @default(true) @map("push_enabled")
  updatedAt       DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamptz()

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("notification_settings")
}

// ============================================================
// 16. 友達招待テーブル
// ============================================================
model Referral {
  id           String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  referrerId   String    @map("referrer_id") @db.Uuid
  referredId   String?   @map("referred_id") @db.Uuid
  referralCode String    @unique @map("referral_code") @db.VarChar(20)
  status       String    @default("pending") @db.VarChar(20)
  createdAt    DateTime  @default(now()) @map("created_at") @db.Timestamptz()
  completedAt  DateTime? @map("completed_at") @db.Timestamptz()

  referrer User  @relation("Referrer", fields: [referrerId], references: [id], onDelete: Cascade)
  referred User? @relation("Referred", fields: [referredId], references: [id], onDelete: SetNull)

  @@index([referrerId])
  @@index([referralCode])
  @@map("referrals")
}

// ============================================================
// 17. 監査ログテーブル
// ============================================================
model AuditLog {
  id          String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  adminId     String   @map("admin_id") @db.Uuid
  action      String   @db.VarChar(100)
  targetType  String   @map("target_type") @db.VarChar(50)
  targetId    String?  @map("target_id") @db.VarChar(255)
  beforeValue Json?    @map("before_value")
  afterValue  Json?    @map("after_value")
  ipAddress   String?  @map("ip_address")
  createdAt   DateTime @default(now()) @map("created_at") @db.Timestamptz()

  admin User @relation(fields: [adminId], references: [id])

  @@index([adminId])
  @@index([targetType, targetId])
  @@index([createdAt(sort: Desc)])
  @@map("audit_logs")
}

// ============================================================
// 18. マイルボーナスキャンペーンテーブル
// ============================================================
model MileCampaign {
  id          String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name        String   @db.VarChar(200)
  multiplier  Decimal  @default(1.0) @db.Decimal(3, 1)
  actionCodes String[] @map("action_codes")
  startsAt    DateTime @map("starts_at") @db.Timestamptz()
  endsAt      DateTime @map("ends_at") @db.Timestamptz()
  isActive    Boolean  @default(true) @map("is_active")
  createdAt   DateTime @default(now()) @map("created_at") @db.Timestamptz()

  @@map("mile_campaigns")
}

// ============================================================
// 19. Zoom ユーザーマッピングテーブル
// ============================================================
model ZoomUserMapping {
  id         String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId     String   @map("user_id") @db.Uuid
  zoomEmail  String   @unique @map("zoom_email")
  zoomUserId String?  @map("zoom_user_id")
  verified   Boolean  @default(false)
  createdAt  DateTime @default(now()) @map("created_at") @db.Timestamptz()
  updatedAt  DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamptz()

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("zoom_user_mappings")
}

// ============================================================
// 20. Zoom 会議記録テーブル
// ============================================================
model ZoomMeetingRecord {
  id              String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  zoomMeetingId   String    @map("zoom_meeting_id")
  zoomMeetingUuid String    @unique @map("zoom_meeting_uuid")
  topic           String
  startTime       DateTime  @map("start_time") @db.Timestamptz()
  endTime         DateTime? @map("end_time") @db.Timestamptz()
  durationMinutes Int?      @map("duration_minutes")
  eventId         String?   @map("event_id") @db.Uuid
  recordingUrl    String?   @map("recording_url")
  status          String    @default("scheduled") @db.VarChar(20)
  createdAt       DateTime  @default(now()) @map("created_at") @db.Timestamptz()

  event          Event?                @relation(fields: [eventId], references: [id])
  participations ZoomParticipationLog[]

  @@index([zoomMeetingId])
  @@index([status])
  @@map("zoom_meeting_records")
}

// ============================================================
// 21. Zoom 参加ログテーブル
// ============================================================
model ZoomParticipationLog {
  id              String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId          String?   @map("user_id") @db.Uuid
  meetingRecordId String    @map("meeting_record_id") @db.Uuid
  zoomEmail       String    @map("zoom_email")
  joinTime        DateTime  @map("join_time") @db.Timestamptz()
  leaveTime       DateTime? @map("leave_time") @db.Timestamptz()
  durationMinutes Int?      @map("duration_minutes")
  milesAwarded    Int       @default(0) @map("miles_awarded")
  createdAt       DateTime  @default(now()) @map("created_at") @db.Timestamptz()

  user          User?             @relation(fields: [userId], references: [id])
  meetingRecord ZoomMeetingRecord @relation(fields: [meetingRecordId], references: [id], onDelete: Cascade)

  @@unique([userId, meetingRecordId])
  @@index([userId])
  @@index([meetingRecordId])
  @@map("zoom_participation_logs")
}
