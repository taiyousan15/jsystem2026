# Threat Model: sns-research-tool

> STRIDE脅威モデリング。SNSリサーチ分析ツールのセキュリティリスク特定と緩和策定義。

## 1. 概要

| 項目 | 値 |
|------|-----|
| 対象システム | SNS Research Tool |
| 分析日 | 2026-02-03 |
| 分析者 | Claude Code |
| レビュー者 | - |

## 2. 保護対象資産（Assets）

| ID | 資産 | 分類 | 重要度 | 説明 |
|----|------|------|--------|------|
| A-001 | ユーザー認証情報 | Confidential | Critical | パスワード、JWT、リフレッシュトークン |
| A-002 | SNS APIキー | Confidential | Critical | X/Instagram/TikTok APIアクセストークン |
| A-003 | ユーザーPII | Restricted | High | メールアドレス、名前 |
| A-004 | SNS分析データ | Internal | Medium | フォロワー数、エンゲージメント、投稿内容 |
| A-005 | レポートデータ | Internal | Medium | 生成されたPDF/Excelファイル |
| A-006 | 監査ログ | Internal | High | 操作履歴、IPアドレス |
| A-007 | システム設定 | Internal | Medium | DB接続情報、環境変数 |

### データ分類基準

| 分類 | 定義 | 例 |
|------|------|-----|
| **Confidential** | 漏洩時に重大な損害 | パスワード、APIキー |
| **Restricted** | 法的保護対象 | PII、メールアドレス |
| **Internal** | 社内限定 | 分析データ、設定 |
| **Public** | 公開可能 | ドキュメント |

## 3. 信頼境界（Trust Boundaries）

```
┌─────────────────────────────────────────────────────────────────┐
│                        Internet                                  │
│  ┌─────────────┐      ┌─────────────┐                           │
│  │   User      │      │  Attacker   │                           │
│  └──────┬──────┘      └──────┬──────┘                           │
│         │                    │                                   │
│ ════════╪════════════════════╪══════════════════════════════════│ TB-1: Internet/DMZ
│         │                    │                                   │
│         ▼                    ▼                                   │
│  ┌─────────────────────────────────────┐                        │
│  │     CloudFront + WAF                 │                        │
│  └──────────────────┬──────────────────┘                        │
│                     │                                            │
│ ════════════════════╪════════════════════════════════════════════│ TB-2: DMZ/App
│                     ▼                                            │
│  ┌───────────────────────────────────────────────────────┐      │
│  │                  App Tier (VPC)                        │      │
│  │  ┌──────────┐    ┌──────────┐    ┌──────────┐        │      │
│  │  │   Web    │───▶│   API    │───▶│  Worker  │        │      │
│  │  │ (Next.js)│    │(Express) │    │ (BullMQ) │        │      │
│  │  └──────────┘    └────┬─────┘    └────┬─────┘        │      │
│  └───────────────────────┼───────────────┼───────────────┘      │
│                          │               │                       │
│ ═════════════════════════╪═══════════════╪═══════════════════════│ TB-3: App/Data
│                          ▼               ▼                       │
│  ┌───────────────────────────────────────────────────────┐      │
│  │                  Data Tier (Private Subnet)            │      │
│  │  ┌──────────┐    ┌──────────┐    ┌──────────┐        │      │
│  │  │   RDS    │    │  Redis   │    │ Secrets  │        │      │
│  │  │PostgreSQL│    │ Cache    │    │ Manager  │        │      │
│  │  └──────────┘    └──────────┘    └──────────┘        │      │
│  └───────────────────────────────────────────────────────┘      │
│                                                                  │
│ ═════════════════════════════════════════════════════════════════│ TB-4: Internal/External
│                          │                                       │
│                          ▼                                       │
│  ┌───────────────────────────────────────────────────────┐      │
│  │              External APIs                             │      │
│  │  ┌──────────┐  ┌──────────┐  ┌──────────┐            │      │
│  │  │  X API   │  │Instagram │  │ TikTok   │            │      │
│  │  │   v2     │  │ Graph API│  │  API     │            │      │
│  │  └──────────┘  └──────────┘  └──────────┘            │      │
│  └───────────────────────────────────────────────────────┘      │
└─────────────────────────────────────────────────────────────────┘
```

| 境界ID | 境界 | 通過データ | 保護機構 |
|--------|------|-----------|---------|
| TB-1 | Internet/DMZ | ユーザーリクエスト | WAF, TLS 1.3, レート制限 |
| TB-2 | DMZ/App | 内部リクエスト | ALB, セキュリティグループ |
| TB-3 | App/Data | DBクエリ、キャッシュ | VPC, 暗号化接続 |
| TB-4 | Internal/External | SNS APIリクエスト | TLS, APIキー認証 |

## 4. STRIDE脅威分析

### 4.1 Spoofing（なりすまし）

| ID | 脅威 | 対象 | 攻撃シナリオ | 影響 | 可能性 | リスク | 緩和策 | 対応要件 |
|----|------|------|-------------|------|--------|--------|--------|---------|
| T-S01 | 認証情報盗取 | A-001 | フィッシング、キーロガー | Critical | Medium | High | MFA（Phase 2）、パスワード強度要件 | REQ-001 |
| T-S02 | セッションハイジャック | A-001 | XSS経由のトークン窃取 | High | Medium | High | HttpOnly Cookie、CSP | REQ-SEC-001 |
| T-S03 | JWTトークン偽造 | A-001 | 弱い署名アルゴリズム | Critical | Low | Medium | RS256使用、短期有効期限（15分） | REQ-SEC-001 |
| T-S04 | APIキーなりすまし | A-002 | 漏洩したAPIキーの悪用 | High | Medium | High | Secrets Manager、ローテーション | REQ-SEC-002 |

### 4.2 Tampering（改ざん）

| ID | 脅威 | 対象 | 攻撃シナリオ | 影響 | 可能性 | リスク | 緩和策 | 対応要件 |
|----|------|------|-------------|------|--------|--------|--------|---------|
| T-T01 | リクエスト改ざん | A-004 | パラメータ操作（accountId等） | High | High | High | 入力検証、Zod/Joi | REQ-002 |
| T-T02 | SQLインジェクション | A-003, A-004 | 悪意あるSQL注入 | Critical | Medium | High | Prisma ORM（パラメータ化）、入力サニタイズ | - |
| T-T03 | レポート改ざん | A-005 | 生成済みファイルの書き換え | Medium | Low | Low | 署名付きURL、イミュータブル保存 | REQ-007 |
| T-T04 | ログ改ざん | A-006 | 監査ログの削除・変更 | High | Low | Medium | 別ストレージ、書き込み専用 | REQ-SEC-003 |

### 4.3 Repudiation（否認）

| ID | 脅威 | 対象 | 攻撃シナリオ | 影響 | 可能性 | リスク | 緩和策 | 対応要件 |
|----|------|------|-------------|------|--------|--------|--------|---------|
| T-R01 | 操作否認 | A-006 | 「私はやっていない」主張 | Medium | Medium | Medium | 監査ログ必須化 | REQ-SEC-003 |
| T-R02 | ログイン否認 | A-006 | 不正ログインの否認 | Medium | Low | Low | IP/UA記録、タイムスタンプ | REQ-SEC-003 |

### 4.4 Information Disclosure（情報漏洩）

| ID | 脅威 | 対象 | 攻撃シナリオ | 影響 | 可能性 | リスク | 緩和策 | 対応要件 |
|----|------|------|-------------|------|--------|--------|--------|---------|
| T-I01 | APIキー漏洩 | A-002 | ログ出力、コード内ハードコード | Critical | Medium | Critical | AES-256暗号化、ログマスキング | REQ-SEC-002 |
| T-I02 | PII漏洩 | A-003 | 不正アクセス、バックアップ漏洩 | High | Medium | High | 暗号化、アクセス制御 | - |
| T-I03 | エラーメッセージ漏洩 | A-007 | スタックトレース表示 | Medium | High | Medium | 本番エラーマスキング | - |
| T-I04 | IDOR（直接オブジェクト参照） | A-004, A-005 | 他ユーザーのデータアクセス | High | High | High | 所有者検証必須 | - |

### 4.5 Denial of Service（サービス拒否）

| ID | 脅威 | 対象 | 攻撃シナリオ | 影響 | 可能性 | リスク | 緩和策 | 対応要件 |
|----|------|------|-------------|------|--------|--------|--------|---------|
| T-D01 | DDoS攻撃 | システム全体 | 大量リクエスト | High | Medium | High | CloudFront、WAF、レート制限 | REQ-902 |
| T-D02 | APIレート制限消費 | A-002 | 意図的な大量リクエスト | Medium | Medium | Medium | ユーザー別レート制限 | REQ-003 |
| T-D03 | レポート生成負荷攻撃 | システム全体 | 大量レポート生成リクエスト | Medium | Low | Low | キュー制限、ユーザー別クォータ | REQ-007 |
| T-D04 | DB接続枯渇 | A-007 | 大量接続、Slowloris | High | Low | Medium | コネクションプール、タイムアウト | REQ-902 |

### 4.6 Elevation of Privilege（権限昇格）

| ID | 脅威 | 対象 | 攻撃シナリオ | 影響 | 可能性 | リスク | 緩和策 | 対応要件 |
|----|------|------|-------------|------|--------|--------|--------|---------|
| T-E01 | 水平権限昇格 | A-003, A-004 | 他チームのデータアクセス | High | High | High | チームID検証必須 | - |
| T-E02 | 垂直権限昇格 | 全資産 | member→admin権限取得 | Critical | Medium | Critical | RBAC厳密化、トークンにrole埋め込み | REQ-010 |
| T-E03 | 招待リンク悪用 | A-003 | 期限切れリンクの再利用 | Medium | Low | Low | ワンタイムトークン、72時間有効期限 | REQ-010 |

## 5. リスクマトリックス

```
影響度 →    Low        Medium      High        Critical
可能性↓
────────┼───────────────────────────────────────────────
High    │ Medium     High        Critical    Critical
        │ T-I03      T-T01,T-I04 T-D01,T-E01
        │            T-D02
Medium  │ Low        Medium      High        Critical
        │ T-T03      T-R01       T-S01,T-S04 T-I01,T-E02
        │                        T-I02
Low     │ Low        Low         Medium      High
        │ T-R02,T-E03 T-T04      T-D03,T-D04 T-S03
        │            T-D03
────────┼───────────────────────────────────────────────
```

## 6. 緩和策サマリー

| 優先度 | 緩和策 | 対応脅威 | 実装コスト | 対応要件 |
|--------|--------|---------|-----------|---------|
| **P1** | 入力検証（Zod/Joi） | T-T01, T-T02 | Low | REQ-002 |
| **P1** | 所有者/チーム検証 | T-I04, T-E01 | Low | - |
| **P1** | APIキー暗号化（AES-256） | T-I01 | Medium | REQ-SEC-002 |
| **P1** | RBAC実装 | T-E02 | Medium | REQ-010 |
| **P1** | 監査ログ | T-R01, T-R02, T-T04 | Low | REQ-SEC-003 |
| **P2** | WAF + レート制限 | T-D01, T-D02 | Medium | REQ-902 |
| **P2** | HttpOnly Cookie + CSP | T-S02 | Low | REQ-SEC-001 |
| **P2** | エラーマスキング | T-I03 | Low | - |
| **P3** | MFA導入 | T-S01 | Medium | Phase 2 |

## 7. セキュリティ要件追加

以下の要件をrequirements.mdに追加済み:

- **REQ-SEC-001**: JWTトークン有効期限（15分/7日）
- **REQ-SEC-002**: APIキー暗号化（AES-256）
- **REQ-SEC-003**: 監査ログ（90日保持）

### 追加推奨要件

```markdown
### REQ-SEC-004: 入力検証
- 種別: EARS-普遍
- 優先度: MUST
- 要件文(EARS): システムはすべてのユーザー入力をZodスキーマで検証しなければならない。
- 受入テスト(GWT): Given 不正な入力値 When APIリクエスト Then 400エラーを返却

### REQ-SEC-005: IDOR防止
- 種別: EARS-普遍
- 優先度: MUST
- 要件文(EARS): システムはリソースアクセス時に所有者またはチームメンバーシップを検証しなければならない。
- 受入テスト(GWT): Given ユーザーAのアカウント When ユーザーBがアクセス Then 403エラーを返却
```

## 8. 関連ドキュメント

- [requirements.md](./requirements.md) - 要件定義（セキュリティ要件追加先）
- [design.md](./design.md) - セキュリティ設計セクション
- [slo.md](./slo.md) - セキュリティ関連SLI/SLO
- [runbook.md](./runbook.md) - セキュリティインシデント対応
- [guardrails.md](./guardrails.md) - AIガードレール
